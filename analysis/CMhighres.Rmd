---
title: "CMhighres"
author: "A.DeMartin"
date: "2025-07-01"
output: 
  html_document:
    keep_md: true
    toc: true
editor_options: 
  chunk_output_type: inline
---
## load packages
```{r load packages, warning=FALSE, include=FALSE}
library(ExploreSCdataSeurat3)
library(runSeurat3)
library(Seurat)
library(ggpubr)
library(pheatmap)
library(SingleCellExperiment)
library(dplyr)
library(tidyverse)
library(viridis)
library(muscat)
library(circlize)
library(destiny)
library(scater)
library(metap)
library(multtest)
library(clusterProfiler)
library(org.Hs.eg.db)
library(msigdbr)
library(enrichplot)
library(DOSE)
library(grid)
library(gridExtra)
library(ggupset)
library(VennDiagram)
library(NCmisc)
```

```{r setup, include=FALSE}
options(width = 100)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234
```

## load object
```{r load merged object, eval=FALSE, include=FALSE}
fileNam <- "/Users/immbio/Desktop/Project/Angelina/HumanHeartCarTrans2/data/Human_heart_allmerged_seurat.rds"
seuratM <- readRDS(fileNam)
```

## set color vectors 
```{r set color vector}
colclusterName <- c("#67001f", "#f4a582","#D53E4F", "#FEE08B","#8c510a","#003c30","#01665e","#66C2A5", "#3288BD","#BEAED4", "#c7eae5", "#B09C85", "#4e5a4c","#393A3F","#355C7D","#202547","#B45B5C","#725663FF","#232429")
names(colclusterName) <- c("CM","Fb1","Fb2","Fb3","PerivFb1","PerivFb2","VSMC","BEC1","BEC2","BEC3","LEC","NC","Baror","Adipoc","Mph1","Mph2","Tcell1","Tcell2","Mastcell")

coldiseaseCond <- c("#dfc27d","#202547","#355C7D","#779d8d", "#BE3144")
names(coldiseaseCond) <- c("healthy", "visit1", "visit2", "visit3", "explant")
```

## subset CM
```{r, eval=FALSE, include=TRUE}
Idents(seuratM) <- seuratM$clusterName
seuratCM <- subset(seuratM, idents = c("CM"))
levels(seuratCM)
table(seuratCM$orig.ident)
table(seuratCM$clusterName)
DimPlot(seuratCM, reduction = "umap", cols = colclusterName)
remove(seuratM)
```

## rerun seurat
```{r, eval=FALSE, include=TRUE}
##recreate assay 
seuratCM@assays$RNA@layers$data = NULL
seuratCM@assays$RNA@layers$scale.data = NULL
counts = GetAssayData(seuratCM, assay = "RNA", layer = "counts")
seuratCM[["RNA"]] = CreateAssayObject(counts = counts)

##rerun seurat
seuratCM <- NormalizeData (object = seuratCM)
seuratCM <- FindVariableFeatures(object = seuratCM)
seuratCM <- ScaleData(object = seuratCM, verbose = TRUE)
seuratCM <- RunPCA(object=seuratCM, npcs = 30, verbose = FALSE)
seuratCM <- RunTSNE(object=seuratCM, reduction="pca", dims = 1:20)
seuratCM <- RunUMAP(object=seuratCM, reduction="pca", dims = 1:20)
seuratCM <- FindNeighbors(object = seuratCM, reduction = "pca", dims= 1:20)

res <- c(0.25, 0.6, 0.8, 0.4, 0.1)
for (i in 1:length(res)) {
  seuratCM <- FindClusters(object = seuratCM, resolution = res[i], random.seed = 1234)
}

table(seuratCM$orig.ident)
table(seuratCM$RNA_snn_res.0.25)
table(seuratCM$RNA_snn_res.0.1)
```

```{r, eval=FALSE, include=TRUE}
### save seurat object
saveRDS(seuratCM, file="/Users/immbio/Desktop/Project/Angelina/HumanHeartCarTrans2/data/Human_heart_CM.rds")
```

## load CM
```{r}
fileNam <- "/Users/immbio/Desktop/Project/Angelina/HumanHeartCarTrans2/data/Human_heart_CM.rds"
seuratCM <- readRDS(fileNam)
table(seuratCM$dataset)
table(seuratCM$RNA_snn_res.0.25)
table(seuratCM$orig.ident)
```

## umaps
```{r umaps}
colCM <- c("#003c30", "#3288BD","#BEAED4", "#c7eae5", "#B09C85", "#4e5a4c","#393A3F","#355C7D","#202547","#B45B5C","#725663FF","#232429")
names(colCM) <- unique(seuratCM$RNA_snn_res.0.25)

Idents(seuratCM) <- seuratCM$RNA_snn_res.0.25
DimPlot(seuratCM, reduction = "umap", pt.size = 0.5, label = TRUE, cols = colCM)

Idents(seuratCM) <- seuratCM$RNA_snn_res.0.1
DimPlot(seuratCM, reduction = "umap", pt.size = 0.5, label = TRUE, cols = colCM)

Idents(seuratCM) <- seuratCM$diseaseCond
DimPlot(seuratCM, reduction = "umap", pt.size = 0.5, cols = coldiseaseCond)
DimPlot(seuratCM, reduction = "umap", pt.size = 0.5, cols = coldiseaseCond) + theme(legend.position = "null")
```

## calculate cluster marker genes
```{r cluster marker genes, include=TRUE, eval=FALSE}
##cluster marker
Idents(seuratCM) <- seuratCM$RNA_snn_res.0.25
markerGenes <- FindAllMarkers(seuratCM, only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01)

#save table
write.table(markerGenes, 
            file= "/Users/immbio/Desktop/Project/Angelina/HumanHeartCarTrans2/data/markerGenesCMRNA_snn_res.0.25",
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)

##cluster marker
Idents(seuratCM) <- seuratCM$RNA_snn_res.0.1
markerGenes <- FindAllMarkers(seuratCM, only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01)

#save table
write.table(markerGenes, 
            file= "/Users/immbio/Desktop/Project/Angelina/HumanHeartCarTrans2/data/markerGenesCMRNA_snn_res.0.1",
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

## BMP features 
```{r features}
genes <- data.frame(gene=rownames(seuratCM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("HGF", "MET", "GREM1", "GREM2", "BMPR1A", "BMPR2", "BMP2K", "BMP8A", "BMP1", "BMP6", "BMP2", "BMP5", "BMP4")) %>% 
  left_join(., genes, by="geneID")

pList <- sapply(selGenes$gene, function(x){
  p <- FeaturePlot(seuratCM, features = x, reduction = "umap", pt.size = 0.1, cols = c("lightgrey", "#BE3144"), raster = FALSE) +
    theme(legend.position="right")
  plot(p)
})
```

## abundance plots
### dataset
```{r abundance dataset AllFb, fig.height=10, fig.width=10}
order_keywords <- c("HH","V1", "V2","V3","RV|LV|expLV|expRV|331571_3-5_20231012_Hu_nucseq_USZ_HTx001|331571_4-6_20231012_Hu_nucseq_USZ_HTx002")
files <- unique(seuratCM$dataset)
ordered_files <- c()
for (key in order_keywords) {
  ordered_files <- c(ordered_files, files[grepl(key, files)])
}

###dataset
datList <- NULL
for(con in unique(seuratCM$dataset)){
  seuratSub <- subset(seuratCM, dataset==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$RNA_snn_res.0.1)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(dataset=con)
  datList[[con]] <- dat_con
}
dat_all <- do.call("rbind", datList)

## plot abundance
ggbarplot(dat_all, x= "dataset", y= "percent", fill = "Var1", palette = colCM, legend = "right", legend.titel = "cluster", ylab = "frequency")  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_x_discrete(limits=ordered_files)
```

### patient_diseaseCond
```{r abundance patient_diseaseCond AllFb, fig.height=8, fig.width=10}
order_keywords <- c("healthy", "visit1", "visit2", "visit3", "explant", "explant")
files <- unique(seuratCM$patient_diseaseCond)
ordered_files <- c()
for (key in order_keywords) {
  ordered_files <- c(ordered_files, files[grepl(key, files)])
}

###patient_diseaseCond
datList <- NULL
for(con in unique(seuratCM$patient_diseaseCond)){
  seuratSub <- subset(seuratCM, patient_diseaseCond==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$RNA_snn_res.0.1)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(patient_diseaseCond=con)
  datList[[con]] <- dat_con
}
dat_all <- do.call("rbind", datList)

## plot abundance
ggbarplot(dat_all, x= "patient_diseaseCond", y= "percent", fill = "Var1", palette = colCM, legend = "right", legend.titel = "cluster", ylab = "frequency")  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_x_discrete(limits=ordered_files)
```

### diseaseCond
```{r abundance diseaseCoond AllFb, fig.height=8, fig.width=10}
orddiseaseCond <- c("healthy","visit1", "visit2" ,"visit3", "explant")

###diseaseCond
datList <- NULL
for(con in unique(seuratCM$diseaseCond)){
  seuratSub <- subset(seuratCM, diseaseCond==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$RNA_snn_res.0.1)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(diseaseCond=con)
  datList[[con]] <- dat_con
}
dat_all <- do.call("rbind", datList)

## plot abundance
ggbarplot(dat_all, x= "diseaseCond", y= "percent", fill = "Var1", palette = colCM, legend = "right", legend.titel = "cluster", ylab = "frequency")  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_x_discrete(limits=orddiseaseCond)
```

```{r GSEA CM0, fig.height=12, fig.width=12}
## load marker genes
markerGenes <- read.delim("/Users/immbio/Desktop/Project/Angelina/HumanHeartCarTrans2/data/markerGenesCMRNA_snn_res.0.1", header = TRUE, sep = "\t")

## adjust table
markerG <- dplyr::filter(markerGenes, cluster == "0")
markerG <- markerG %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

## GSEA 
ego <- enrichGO(gene = unique(markerG$EnsID),
                          OrgDb = org.Hs.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
ego <- setReadable(ego, OrgDb = org.Hs.eg.db)
dotplot(ego, showCategory=30)
```

### convert to sce 
```{r}
##convert seurat object to sce object
##exteract logcounts
logcounts <- GetAssayData(seuratCM, assay = "RNA", slot = "data")
counts <- GetAssayData(seuratCM, assay = "RNA", slot = "counts")
##extract reduced dims from integrated assay
pca <- Embeddings(seuratCM, reduction = "pca")
umap <- Embeddings(seuratCM, reduction = "umap")
##create sce object
sce <- SingleCellExperiment(assays =list (
  counts = counts,
  logcounts = logcounts
),
colData = seuratCM@meta.data,
rowData = data.frame(gene_id = rownames(logcounts)),
reducedDims = SimpleList(
  PCA = pca,
  UMAP = umap
))

genes <- data.frame(geneID=rownames(sce)) %>% mutate(gene=gsub(".*\\.", "", geneID))
pal = colorRampPalette(c("#053061", "#2166ac", "#f7f7f7", "#f4a582", "#b2183c", "#85122d"))
```

## project signatures
### response to starvation
```{r response to starvation}
ego1 <- dplyr::filter(ego@result, ego@result$Description=="response to starvation")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1.5))
sceSub$sign2[which(sceSub$sign > 1.5)] <- 1.5
sceSub$sign2[which(sceSub$sign < 0)] <- 0
##check max and min values
max(sceSub$sign)
min(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc
```

### muscle system process
```{r muscle system process}
ego1 <- dplyr::filter(ego@result, ego@result$Description=="muscle system process")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1.9))
sceSub$sign2[which(sceSub$sign > 1.9)] <- 1.9
sceSub$sign2[which(sceSub$sign < 0)] <- 0
##check max and min values
max(sceSub$sign)
min(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc
```

### response to peptide hormone
```{r response to peptide hormone}
ego1 <- dplyr::filter(ego@result, ego@result$Description=="response to peptide hormone")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1.5))
sceSub$sign2[which(sceSub$sign > 1.5)] <- 1.5
sceSub$sign2[which(sceSub$sign < 0)] <- 0
##check max and min values
max(sceSub$sign)
min(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc
```

```{r GSEA CM1, fig.height=12, fig.width=12}
## adjust table
markerG <- dplyr::filter(markerGenes, cluster == "1")
markerG <- markerG %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

## GSEA 
ego <- enrichGO(gene = unique(markerG$EnsID),
                          OrgDb = org.Hs.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
ego <- setReadable(ego, OrgDb = org.Hs.eg.db)
dotplot(ego, showCategory=30)
```

### energy derivation by oxidation of organic compounds
```{r energy derivation by oxidation of organic compounds}
ego1 <- dplyr::filter(ego@result, ego@result$Description=="energy derivation by oxidation of organic compounds")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.8))
sceSub$sign2[which(sceSub$sign > 0.8)] <- 0.8
sceSub$sign2[which(sceSub$sign < 0)] <- 0
##check max and min values
max(sceSub$sign)
min(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc
```

### cellular respiration
```{r cellular respiration}
ego1 <- dplyr::filter(ego@result, ego@result$Description=="cellular respiration")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceSub$sign2[which(sceSub$sign > 0.9)] <- 0.9
sceSub$sign2[which(sceSub$sign < 0)] <- 0
##check max and min values
max(sceSub$sign)
min(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc
```

### heart contraction
```{r heart contraction}
ego1 <- dplyr::filter(ego@result, ego@result$Description=="heart contraction")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1.4))
sceSub$sign2[which(sceSub$sign > 1.4)] <- 1.4
sceSub$sign2[which(sceSub$sign < 0)] <- 0
##check max and min values
max(sceSub$sign)
min(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc
```

## BMP downstream signaling (NCR genes)
```{r dotplot BMP downstream1, fig.width=10, fig.height=6}
genes <- data.frame(gene=rownames(seuratCM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("SP1", "SMAD9", "SMAD5", "SMAD4", "SMAD1", "RUNX2", "PAX9", "MSX2", "MSX1", "KLF4", "ID4", "ID3", "ID2", "ID1")) %>% left_join(., genes, by="geneID")

DotPlot(seuratCM, features = selGenes, group.by= "RNA_snn_res.0.1") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## BMP downstream signaling (upreg in iPSCs after BMP stim)
```{r dotplot BMP downstream2, fig.width=10, fig.height=6}
genes <- data.frame(gene=rownames(seuratCM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("ID1","ID2", "ID4", "SMAD9","SMAD6", "SMAD7")) %>% left_join(., genes, by="geneID")

DotPlot(seuratCM, features = selGenes, group.by= "RNA_snn_res.0.1") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## BMP downstream signaling (NCR genes)
```{r dotplot BMP downstream3, fig.width=10, fig.height=6}
genes <- data.frame(gene=rownames(seuratCM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("SP1", "SMAD9", "SMAD5", "SMAD4", "SMAD1", "RUNX2", "PAX9", "MSX2", "MSX1", "KLF4", "ID4", "ID3", "ID2", "ID1")) %>% left_join(., genes, by="geneID")

DotPlot(seuratCM, features = selGenes, group.by= "RNA_snn_res.0.25") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## BMP downstream signaling (upreg in iPSCs after BMP stim)
```{r dotplot BMP downstream4, fig.width=10, fig.height=6}
genes <- data.frame(gene=rownames(seuratCM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=c("ID1","ID2", "ID4", "SMAD9","SMAD6", "SMAD7")) %>% left_join(., genes, by="geneID")

DotPlot(seuratCM, features = selGenes, group.by= "RNA_snn_res.0.25") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## session info
```{r date and session info}
date()
sessionInfo()
```
